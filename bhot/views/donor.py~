from flask import render_template, flash, redirect

from bhot import app,csrf
from bhot.models import db
from bhot.models.recipient import Recipient
from bhot.forms.recipient import RecipientForm

@app.route("/recipient/add", methods=["GET","POST"])
def recipient_add():
    f = RecipientForm()
    if f.validate_on_submit():
        r = Recipient()
        f.copy_to_db_model(r)
        db.session.add(r)
        db.session.commit()
        flash('New Recipient Added','success')
        return redirect("/")
    return render_template("recipient.html", form=f)


@app.route("/recipient/edit/<id>", methods=["GET","POST"])
def recipient_edit(id):
    r = Recipient.query.filter_by(recipient_id=id).first()
    if not r:
        #TODO: Log
        abort(400)

    f = RecipientForm()

    if f.validate_on_submit():
        f.copy_to_db_model(r)
        db.session.add(r)
        db.session.commit()
        flash('Recipient Updated','success')
        return redirect("/")
    else:
        f.copy_from_db_model(r)

    return render_template("recipient.html", form=f)


@app.route("/recipient/list")
def recipient_list():
    r = Recipient.query.all()
    return render_template("recipient-list.html", recipients=r)
