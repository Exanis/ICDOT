from flask import render_template, flash, redirect

from bhot import app,csrf
from bhot.models import db
from bhot.models.donor import Donor
from bhot.forms.donor import DonorForm

@app.route("/donor/add", methods=["GET","POST"])
def donor_add():
    f = DonorForm()
    if f.validate_on_submit():
        r = Donor()
        f.copy_to_db_model(r)
        db.session.add(r)
        db.session.commit()
        flash('New Donor Added','success')
        return redirect("/")
    return render_template("donor.html", form=f)


@app.route("/donor/edit/<id>", methods=["GET","POST"])
def donor_edit(id):
    r = Donor.query.filter_by(donor_id=id).first()
    if not r:
        #TODO: Log
        abort(400)

    f = DonorForm()

    if f.validate_on_submit():
        f.copy_to_db_model(r)
        db.session.add(r)
        db.session.commit()
        flash('Donor Updated','success')
        return redirect("/")
    else:
        f.copy_from_db_model(r)

    return render_template("donor.html", form=f)


@app.route("/donor/list")
def donor_list():
    r = Donor.query.all()
    return render_template("donor-list.html", donors=r)
